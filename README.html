<html>
<head>
<title>Discrete Choice Experiments</title>
<link rel="stylesheet" type="text/css" href="static/styles.css" />
<style type="text/css">
  body {bgcolor:'lightyellow';}
  pre {font-size:100%; margin-left:2ex;}
</style>
</head>
<body>
<a name="top" />
<h1>Discrete Choice Experiments</h1>

<p>Author: Mike Lake <br>
Version of this Doc: 17 Feb 2014
</p>

<pre>
<a href="#description"/>Description</a>
<a href="#release"/>New Version Release at Nectar</a>
<a href="#required"/>Software Required</a>
<a href="#setup"/>System Setup at Nectar</a>
<a href="#programs"/>Two Programs - choice.py and process_choices.py</a>
<a href="#linux"/>Running under Linux</a>
<a href="#tests"/>Running Regression Tests</a>
<a href="#wsgi"/>Testing a Minimal WSGI App</a>
<a href="#windows"/>Running under Microsoft Windows </a>
<a href="#problems"/>Problems Encountered</a> 
<a href="#tosort"/>To Sort</a> 
<a href="#refs"/>Programming References</a>
</pre>

<a name="description"/><h2>Description</h2>

<p>This describes the python scripts that run the web based 
&quot;Discrete Choice Experiments&quot;. 
This was written for for Deborah Street and Leonie Burgess. 
Mike Lake wrote the choice.py and Emily Bird (from Maths) wrote the main functions in 
process_choices.py.  
</p>

<p><a href="#top">Top</a></p>

<a name="release"/><h2>New Version Release at Nectar</h2>

<p>This is how to do a new release at the Nectar hosted site.
</p>

<pre>
1. Update version numbers for:
   choice.py               version = '2013.10.23' 
   choice_common.py
   process_choices.py

   The version number for all programs should all be set to the same date.

2. Turn off TEST in choice.py

   At the top of the program set 
   "TEST = False"

3. Rsync to Nectar
   This will just make a tarball of some the files and scp the tarball to Nectar. 
   It will do nothing else.
   $ ./release_to_nectar.sh 

4. Login to Nectar 
   $ ssh -i ~/.ssh/keys/mikes_nectar ec2-user@115.146.85.135
  
   Your home directory will be /home/ec2-user/
   The tarball will be in public_html/
  
   $ cd public_html 
   $ tar xvf choice_release_2014.01.07.tar  &lt;-- This will create directory choice_2014.01.07/
   $ rm choice_release_2014.01.07.tar

   $ sudo systemctl stop nginx.service

   $ rm choice                                &lt;-- this is a symlink to a release
   $ ln -s choice_release_2014.01.07  choice  &lt;-- create new symlink

   $ sudo systemctl start nginx.service
   $ sudo systemctl restart emperor.uwsgi.service
 
5. Check <a href="http://115.146.85.135">http://115.146.85.135/choice</a> 
   It should show the correct version number at the bottom left of the page. 
</pre>

<a name="required"/><h2>Software Required</h2>

<p>This is installed onto a "Fedora release 19".
The following software is required:</p>

<pre>
Fedora Package          Provides
--------------          --------
python                  provides Python 2.7.5
python-bottle           provides micro web framework
python-cheetah          provides templating system
nginx                   provides web server
uwsgi                   only provides /usr/sbin/uwsgi
uwsgi-plugin-python     only provides /usr/lib64/uwsgi/python_plugin.so
                        pulls in uwsgi-plugin-common as a dependency
numpy                   provides numerical array maths

sympy-sympy-0.7.2.tar   provides symbolic maths for python from http://sympy.org
</pre>

<p><a href="#top">Top</a></p>

<a name="setup"/><h2>System Setup at Nectar</h2>

<h3>Nginx Setup at Nectar</h3>

<p>Mike made some global changes to nginx configuration files. 
The changes are documented in these files. Search for MRL strings for changes. 
</p>

<pre>
/etc/nginx/nginx.conf
/etc/nginx/conf.d/default.conf  <-- contains hello and choice apps
</pre>

<h3>uWSGI Setup at Nectar</h3>

Install package uwsgi -- this will just install /usr/sbin/uwsgi and some doc files. 

<pre>
Create /etc/uwsgi/emperor.ini
Create /etc/uwsgi/vassals/hello.ini   &lt;-- for testing 
Create /etc/uwsgi/vassals/choice.ini  &lt;-- main application
</pre>

<h3>systemd Setup at Nectar</h3>

<p>At Nectar we are running a systemd based init system which replaces the
older SysV init system. See <tt>/etc/init.d/README</tt>. 
Files are in: <tt>/etc/systemd/system</tt> and some of these are symlinks to files in 
<tt>/usr/lib/systemd/system</tt> 
</p>

<p>Basic usage: </p>

<pre>
systemctl start foobar.service
systemctl stop foobar.service
systemctl status foobar.service
systemctl list-unit-files
</pre>

<p>Created a file: <tt>emperor.uwsgi.service</tt> in <tt>/etc/systemd/system/</tt> <br>
Now start the emperor service and check that it is running. </p>

<pre>
$ sudo systemctl start emperor.uwsgi.service

$ ps ax | grep emper 
  /usr/sbin/uwsgi --ini /etc/uwsgi/emperor.ini

$ sudo systemctl status emperor.uwsgi.service
emperor.uwsgi.service - uWSGI Emperor
   Loaded: loaded (/etc/systemd/system/emperor.uwsgi.service; enabled)
   Active: active (running) since Mon 2014-01-06 15:36:30 EST; 19h ago
   Main PID: 3806 (uwsgi)
   Status: "The Emperor is governing 2 vassals"
   CGroup: name=systemd:/system/emperor.uwsgi.service
           ├─10369 /usr/sbin/uwsgi --ini /etc/uwsgi/emperor.ini
           ├─10370 /usr/sbin/uwsgi --ini choice.ini
           ├─10371 /usr/sbin/uwsgi --ini hello.ini
           ├─10372 /usr/sbin/uwsgi --ini hello.ini
           └─10374 /usr/sbin/uwsgi --ini choice.ini

Jan 06 uwsgi[3806]: [uWSGI] getting INI configuration from /etc/...ni
Jan 06 systemd[1]: Started uWSGI Emperor.
</pre>

<p>Configure it so that it will start at boot time. </p>

<pre>
$ sudo systemctl enable emperor.uwsgi.service
  ln -s '/etc/systemd/system/emperor.uwsgi.service' '/etc/systemd/system/multi-user.target.wants/emperor.uwsgi.service'

$ systemctl list-unit-files | grep emp
  emperor.uwsgi.service   enabled
</pre>
 
<p><a href="#top">Top</a></p>

<a name="programs"/><h2>Two Programs - choice.py and process_choices.py</h2>

<pre>
+--- Users Web Browser ---+
|                         |
|  Javascript validation  | <-- Note 1 
|  for basic checking     |
+-------------------------+
              |
              |
+--- choice.py: web application ---+
|                                  | 
| gets inputs from web browser     |      +--- process_choices.py ----+ 
| inputs_validation()              |      |                           |
|                                  |      | get_expected_io()         |
| write_input_files() ------------------> | read_input_files()        |  
|                                  |      |   ... processing ...      |
|                                  |      |   ... processing ...      |
| read_output_files() <------------------ | write_output_files()      |
|                                  |      +---------------------------+
| creates HTML pages with data     | 
+----------------------------------+
              |
              |
+--- Users Web Browser ---+
|                         |
|         results         |
+-------------------------+
</pre>

<table border=1>
<tr>
    <td>choice.py
<pre>
reads form input values (as dict)  
writes input values to files in a temp dir
runs process_choices.py
reads output values from these files
writes values to web page
</pre>
    </td>
    <td>process_choices.py
<pre>
reads input values from files in temp dir
processes them
writes output values to files in temp dir
</pre>
    </td>
</tr>
</table>


<p>
Note 1: To turn off the javascript validation edit <tt>views/head.tpl</tt> and rename the 
<tt>src="/static/validate.js"</tt> to something &quot;wrong&quot; so it won't load.
</p>

<p><a href="#top">Top</a></p>

<a name="linux"/><h2>Running under Linux</h2>

<h3>Starting the Bottle App </h3>

<pre>
$ nohup python ./choice.py &   &lt;-- Runs COMMAND, ignoring hangup signals.
  nohup: ignoring input and appending output to "nohup.out"
</pre>

<pre>
[ec2-user@choice2 ~]$ ps ax | grep choice
     2:11 avahi-daemon: running [choice2.local]
     1:31 python ./choice.py
     3:14 /usr/bin/python ./choice.py
[ec2-user@choice2 ~]$ 
</pre>

<h3>Running under Bottle's inbuilt web server</h3>

<p><i>This is just for testing - not production!</i></p>

<p>The script choice.py needs to have this:</p>
<pre>
  run(host='localhost', port=8080, reloader=True)
</pre>

<p>Start the script:</p>
<pre>
  choice/$ ./choice.py 
  Bottle server starting up (using WSGIRefServer())...
  Listening on http://localhost:8080/
  Hit Ctrl-C to quit.
</pre>

Go to: <a href="http://localhost/choice">http://localhost/choice</a>

<p>Note: The port=8080 is superfluous as the default port is actually 8080. 
If you try to run  on port 80 you will get a 
"socket.error: [Errno 13] Permission denied error" as you don't have permission 
to bind that that port - even if apache or nginx are not running. 
</p>

<h3>Running under Nginx and Fast CGI</h3>

<p><i>This is how to run for production.</i></p>

<p>The script choice.py needs to have this:</p>
<pre>
  run(server=FlupFCGIServer, port=9000, host='localhost', reloader=True)
</pre>

<p>Start the script:</p>
<pre>
  choice/$ ./choice.py 
  Bottle server starting up (using FlupFCGIServer())...
  Listening on http://127.0.0.1:9000/
  Hit Ctrl-C to quit.
</pre>

<p>Go to: <a href="http://localhost/choice/">http://localhost/choice/</a>
</p>

<p>If you get this web page below then you forgot to start ./choice.py</p>
<pre>
  Possibly Busy
  The page you are looking for is temporarily unavailable. Please try again later. 
</pre>

Note: For Mikes laptop only make sure nginx is running and not apache: 
<pre>
  $ sudo service httpd stop
  Redirecting to /bin/systemctl stop  httpd.service
  choice/$ sudo service nginx start
  Redirecting to /bin/systemctl start  nginx.service
  $ 
</pre>

<p><a href="#top">Top</a></p>

<a name="tests"/><h2>Running Regression Tests</h2>

<p>This should show no output. </p>

<pre>
$ ./regression_test_all.sh
$
</pre>

<p><a href="#top">Top</a></p>

<a name="wsgi"/><h2>Testing a Minimal WSGI App</h2>

<p>With Python, you use the WSGI (Web Server Gateway Interface) on top of an fcgi
or wsgi server which talks to the web server (the fcgi client). <br>
<tt>The web client <-> the web server <-> the socket <-> uwsgi <-> Bottle Application</tt>
</p>

<p>Following:  
<a href="http://perlmaven.com/deploying-pyton-with-uwsgi-on-ubuntu-13-10">
Deploying Python with uWSGI and Nginx on Ubuntu 13.10</a>
</p>

<p style="margin-left:1em;">This site contains a note about including --python. 
Without including the python plugin, if I run: <br>
<tt>$ uwsgi --http-socket :9090 --wsgi-file app.py</tt> &nbsp; 
I'd get the following error: <br>
<tt>uwsgi: unrecognized option '--wsgi-file'</tt> <br>
<tt>getopt_long() error</tt>
</p>

<p>First test hello.py -a minimal WSGI application: <br>
<tt>$ uwsgi --http-socket :9090 --plugin python --wsgi-file hello.py</tt> <br>
Goto: <tt>http://localhost:9090/</tt> it works OK. 
</p>

Now test choice application.
Instead of the command line, we will now use a configuration file. <br>
Created <tt>choice-uwsgi.ini</tt>

<pre>
[uwsgi]
http-socket = :9090  <-- Note: this will be just socket=:9090 in production.
plugin    = python
wsgi-file = /home/mlake/public_html/choice/choice.py 
process   = 3
</pre>

<p style="margin-left:1em;">Note: when we want to use a production version we
need to replace: <br>
<tt>http-socket=:9090</tt> with <tt>socket=:9090</tt> </p>

<p>Now we can launch the uWSGI server using the following command:
</p>

<pre>
$ uwsgi --ini choice-uwsgi.ini
Goto: http://localhost:9090/
</pre>

The choice app displays OK. [Shut down the uWSGI server by pressing Ctrl-C.] 

<p><a href="#top">Top</a></p>

<a name="windows"/><h2>Running under Microsoft Windows </h2>

<p>The web server and its app (i.e. <tt>choice.py</tt>) can't be run under Windows but the 
program <tt>process_choices.py</tt> can be run under Windows. This means that Emily Bird 
can run and debug her code on Windows. For details on this see below.</p>

<p>1. Copy the following files over to the Windows box: 
<tt>process_choices.py</tt> and <tt>choice_common.py</tt><br>
2. Copy the directory <tt>test</tt>  with its test files to the Windows box.<br>
</p>

<p>Then run it like this: </p>

<pre>
C:\choice_emily&gt; C:\Python27\python.exe process_choices.py test\check_main_1 check main
C:\choice_emily&gt; 
</pre>

<p>Note: Regression tests also can't be run under Windows.</p>

<p><a href="#top">Top</a></p>


<a name="problems"/><h2>Problems Encountered</h2> 

<h3>Need uwsgi-plugin-python</h3>

<p>The problem was that the uwsgi process could not be started. </p>

<pre>
[ec2-user@choice2 hello]$ uwsgi --http-socket :9090 --plugin python --wsgi-file hello.py
open("/usr/lib64/uwsgi/python_plugin.so"): No such file or directory [core/utils.c line 3639]
!!! UNABLE to load uWSGI plugin: /usr/lib64/uwsgi/python_plugin.so: cannot open shared object file: No such file or directory !!!
uwsgi: unrecognized option '--wsgi-file'
getopt_long() error
[ec2-user@choice2 hello]$ 
</pre>

<p>Installed uwsgi-plugin-python </p>

<pre>
[ec2-user@choice2 hello]$ uwsgi --http-socket :9090 --plugin python --wsgi-file hello.py
*** Starting uWSGI 1.9.19 (64bit) on [Tue Jan  7 12:21:26 2014] ***
compiled with version: 4.8.2 20131017 (Red Hat 4.8.2-1) on 12 November 2013 18:02:19
os: Linux-3.10.10-200.fc19.x86_64 #1 SMP Thu Aug 29 19:05:45 UTC 2013

Now lynx http://localhost:9090 shows OK
</pre>

<h3>nginx/python Run Problems</h3> 

<p>This is what you should have:</p>

<pre>
[ec2-user@choice2 public_html]$ ps ax | grep choice
 7235 pts/0    S      0:00 python ./choice.py
 7236 pts/0    Sl     0:00 /usr/bin/python ./choice.py
[ec2-user@choice2 public_html]$ 
</pre>

<p>If you get this error on Nectar: <tt>Error: 502 Bad Gateway</tt> then 
chances are that nginx is runing but the <tt>choice.py</tt> app is not.
Try running it manually from the command line to see any errors. 
Don't background it so you can see what the problem is.
</p>
 
<pre>
$ python ./choice.py   &lt;-- no &amp; to see what the problem is.
</pre>

<h3>Sympy Error</h3>

<p>Note: Get the sympy version with "import sympy; sympy.__version__"</p>
<pre>            Python    Sympy    Numpy
Laptop      2.7.3     0.7.1    1.6.2    
Windows     2.7.3     0.7.2    1.7.1
Nectar      2.7.5     0.7.3    1.7.1 &lt;-- has a sympy problem 
Nectar      2.7.5     0.7.2    1.7.1 &lt;-- works OK
LiveShell   2.7.5     0.7.3    1.6.1
</pre>

<p>On laptop running sympy 0.7.1</p>
<pre>
mlake$ python
Python 2.7.3 (default, Jul 24 2012, 10:05:38) 
[GCC 4.7.0 20120507 (Red Hat 4.7.0-5)] on linux2
>>> import sympy
>>> m=[1,2]
>>> sympy.Matrix(m)
[1]
[2]
>>> 
</pre>

<p>On Nectar server running sympy 0.7.3</p>
<pre>
[ec2-user@choice2$ python
Python 2.7.5 (default, Aug 22 2013, 09:31:58) 
[GCC 4.8.1 20130603 (Red Hat 4.8.1-1)] on linux2
>>> import sympy
>>> m=[1,2]
>>> sympy.Matrix(m)
Matrix([
[1],
[2]])
>>> 
</pre>

<p><b>Solved:</b> Removed the yum package sympy (0.7.3) and installed sympy 0.7.2 from 
the tarball source package sympy-sympy-0.7.2.tar. The problem 
has now gone. 
</p>

<p><a href="#top">Top</a></p>

<a name="tosort"/><h2>To Sort</h2> 

<pre>

Example of javascript tooltip: 
<a href="javascript:popUp('/choice/help#effect')">Which effects do you want to estimate?</a>

---------------------------------------------
Implementing a Timeout

http://stackoverflow.com/questions/1191374/subprocess-with-timeout

http://stackoverflow.com/questions/3733270/python-subprocess-timeout

http://howto.pui.ch/post/37471155682/set-timeout-for-a-shell-command-in-python
See 
p = process.ProcessOpen("notepad.exe")
p.wait(timeout=5)

--------------------

subprocess.call(): 

See pydoc subprocess for "call" details. 
This returns 0 if all is OK.
To capture standard error in the result use stderr=STDOUT.
The exception object will have one extra attribute called
'child_traceback', which is a string containing traceback information
from the childs point of view.
See also "check_call"

(['./process_choices.py', 'construct', 'main'], stderr=subprocess.STDOUT)
return_value = subprocess.call(['./process_choices.py', tempdir, 'construct', 'main'] )

-----------------------------
</pre>

<p><a href="#top">Top</a></p>

<a name="refs"/><h2>Programming References</h2>

<pre>
<a href="http://michael.lustfield.net/nginx/bottle-uwsgi-nginx-quickstart">Bottle + UWSGI + Nginx Quickstart</a>
<a href="http://community.webfaction.com/questions/3998/how-to-setup-a-python-bottle-application">How to serve WSGI using Apache</a>
<a href="http://uwsgi-docs.readthedocs.org/en/latest/SystemD.html">SystemD</a>
<a href="http://jawher.me/2012/03/16/multiple-python-apps-with-nginx-uwsgi-emperor-upstart/">Running multiple python apps with nginx and uwsgi in emperor mode - March 2012</a>
<a href="http://www.oelerich.org/using-uwsgi-emperor-systemd/">Using the uWSGI Emperor with systemd</a>
<a href="http://note.kjuly.com/note/nginx-uwsgi-bottle/">NginX + uWSGI + Bottle</a>
<a href="http://linuxgazette.net/115/orr.html">WSGI Explorations in Python</a> Good overview
<a href="http://wiki.nginx.org/PythonFlup">PythonFlup</a>
<a href="http://wiki.nginx.org/HttpUwsgiModule">HttpUwsgiModule</a>
<a href="http://fclef.wordpress.com/2013/01/12/bottle-virtualenv-uwsgi-nginx-installation-on-ubuntu-12-04-1-lts">bottle-virtualenv-uwsgi-nginx-installation-on-ubuntu-12-04-1-lts/</a>
<a href="http://stackoverflow.com/questions/361855/how-to-gracefully-restart-django-running-fcgi-behind-nginx">how-to-gracefully-restart-django-running-fcgi-behind-nginx</a>
<a href="http://helpful.knobs-dials.com/index.php/Mod_wsgi_notes">Mod_wsgi_notes</a>
<a href="http://michael.lustfield.net/nginx/bottle-uwsgi-nginx-quickstart">bottle-uwsgi-nginx-quickstart</a>
<a href="http://articles.slicehost.com/2010/8/27/customizing-nginx-web-logs">customizing-nginx-web-logs</a>
<a href="http://stackoverflow.com/questions/7048057/running-python-through-fastcgi-for-nginx">running-python-through-fastcgi-for-nginx</a>
<a href="http://scardig.com/articoli/2010/02/03/Webpy-deployment-through-Nginx-Fastcgi-Spawn-fcgi-and-Flup.html">Webpy-deployment-through-Nginx-Fastcgi-Spawn-fcgi-and-Flup</a>
</pre>

<p><a href="#top">Top</a></p>

<p>&nbsp; <!-- creates blank line at end --> </p>

</body>
</html>

